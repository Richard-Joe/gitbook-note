
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>内核是如何接收一个网络包的 · GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-intopic-toc/style.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="dma.html" />
    
    
    <link rel="prev" href="./" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../../">
            
                <a href="../../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../../gitbook/">
            
                <a href="../../gitbook/">
            
                    
                    gitbook搭建
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../">
            
                <a href="../">
            
                    
                    网络
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="./">
            
                <a href="./">
            
                    
                    网络基础
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter active" data-level="1.3.1.1" data-path="recv_one_package.html">
            
                <a href="recv_one_package.html">
            
                    
                    内核是如何接收一个网络包的
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.1.2" data-path="dma.html">
            
                <a href="dma.html">
            
                    
                    内核DMA机制
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="../load_balance.html">
            
                <a href="../load_balance.html">
            
                    
                    负载均衡
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.2.1" data-path="../lb/LVS.html">
            
                <a href="../lb/LVS.html">
            
                    
                    LVS
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="../traffic_control.html">
            
                <a href="../traffic_control.html">
            
                    
                    流量控制
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../.." >内核是如何接收一个网络包的</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="&#x5185;&#x6838;&#x662F;&#x5982;&#x4F55;&#x63A5;&#x6536;&#x4E00;&#x4E2A;&#x7F51;&#x7EDC;&#x5305;&#x7684;">&#x5185;&#x6838;&#x662F;&#x5982;&#x4F55;&#x63A5;&#x6536;&#x4E00;&#x4E2A;&#x7F51;&#x7EDC;&#x5305;&#x7684;</h1>
<h2 id="&#x4E00;&#x3001;&#x51C6;&#x5907;&#x5DE5;&#x4F5C;">&#x4E00;&#x3001;&#x51C6;&#x5907;&#x5DE5;&#x4F5C;</h2>
<p>&#x5185;&#x6838;&#x7248;&#x672C;<code>5.14.14</code></p>
<h3 id="&#x6CE8;&#x518C;&#x8F6F;&#x4E2D;&#x65AD;">&#x6CE8;&#x518C;&#x8F6F;&#x4E2D;&#x65AD;</h3>
<hr>
<p>Linux&#x7684;&#x8F6F;&#x4E2D;&#x65AD;&#x90FD;&#x662F;&#x5728;&#x4E13;&#x95E8;&#x7684;&#x5185;&#x6838;&#x7EBF;&#x7A0B;<code>ksoftirqd</code>&#x4E2D;&#x8FDB;&#x884C;&#x7684;&#x3002;&#x8BE5;&#x8FDB;&#x7A0B;&#x7684;&#x6570;&#x91CF;&#x7B49;&#x4E8E;&#x673A;&#x5668;&#x7684;&#x6838;&#x6570;&#x3002;</p>
<pre><code class="lang-shell">root@ubuntu:~# ps aux | grep ksoft
root          12  0.0  0.0      0     0 ?        S    18:16   0:00 [ksoftirqd/0]
root          20  0.0  0.0      0     0 ?        S    18:16   0:00 [ksoftirqd/1]
root          26  0.0  0.0      0     0 ?        S    18:16   0:00 [ksoftirqd/2]
root          32  0.0  0.0      0     0 ?        S    18:16   0:01 [ksoftirqd/3]
</code></pre>
<p>&#x7CFB;&#x7EDF;&#x521D;&#x59CB;&#x5316;&#x65F6;&#xFF0C;&#x8C03;&#x7528;<code>spawn_ksoftirqd</code>&#x6765;&#x521B;&#x5EFA;&#x51FA;<code>ksoftirqd</code>&#x8FDB;&#x7A0B;&#x3002;
&#x5F53;<code>ksoftirqd</code>&#x88AB;&#x521B;&#x5EFA;&#x51FA;&#x6765;&#x4EE5;&#x540E;&#xFF0C;&#x5B83;&#x5C31;&#x4F1A;&#x8FDB;&#x5165;&#x81EA;&#x5DF1;&#x7684;&#x7EBF;&#x7A0B;&#x5FAA;&#x73AF;&#x51FD;&#x6570;<code>ksoftirqd</code>&#x548C;<code>ksoftirqd</code>&#x4E86;&#x3002;&#x4E0D;&#x505C;&#x5730;&#x5224;&#x65AD;&#x6709;&#x6CA1;&#x6709;&#x8F6F;&#x4E2D;&#x65AD;&#x9700;&#x8981;&#x88AB;&#x5904;&#x7406;&#x3002;</p>
<pre><code class="lang-c"><span class="hljs-keyword">static</span> <span class="hljs-keyword">struct</span> smp_hotplug_thread softirq_threads = {
    .store                = &amp;ksoftirqd,
    .thread_should_run    = ksoftirqd_should_run,
    .thread_fn            = run_ksoftirqd,
    .thread_comm        = <span class="hljs-string">&quot;ksoftirqd/%u&quot;</span>,
};

<span class="hljs-keyword">static</span> __<span class="hljs-function">init <span class="hljs-keyword">int</span> <span class="hljs-title">spawn_ksoftirqd</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{
    ...
    BUG_ON(smpboot_register_percpu_thread(&amp;softirq_threads));

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
early_initcall(spawn_ksoftirqd);

<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">smpboot_thread_fn</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *data)</span>
</span>{
    <span class="hljs-keyword">struct</span> smpboot_thread_data *td = data;
    <span class="hljs-keyword">struct</span> smp_hotplug_thread *ht = td-&gt;ht;

    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) {
        ...
        <span class="hljs-keyword">if</span> (!ht-&gt;thread_should_run(td-&gt;cpu)) {
            preempt_enable_no_resched();
            schedule();
        } <span class="hljs-keyword">else</span> {
            __set_current_state(TASK_RUNNING);
            preempt_enable();
            ht-&gt;thread_fn(td-&gt;cpu);
        }
    }
}
</code></pre>
<h3 id="&#x6CE8;&#x518C;&#x786C;&#x4E2D;&#x65AD;">&#x6CE8;&#x518C;&#x786C;&#x4E2D;&#x65AD;</h3>
<hr>
<p>&#x4EE5;Intel e1000 &#x7F51;&#x5361;&#x9A71;&#x52A8;&#x4E3A;&#x4F8B;&#xFF0C;&#x627E;&#x5230;<code>e1000_main.c</code>&#x6E90;&#x7801;&#xFF1A;</p>
<pre><code class="lang-c"><span class="hljs-keyword">static</span> <span class="hljs-keyword">struct</span> pci_driver e1000_driver = {
    ...
    .name     = e1000_driver_name,    <span class="hljs-comment">// &#x9A71;&#x52A8;&#x540D;&#x79F0;</span>
    .probe    = e1000_probe,        <span class="hljs-comment">// &#x8BBE;&#x5907;&#x63D2;&#x5165;&#x5185;&#x6838;&#x65F6;&#x8C03;&#x7528;</span>
    .remove   = e1000_remove,        <span class="hljs-comment">// &#x8BBE;&#x5907;&#x4ECE;&#x5185;&#x6838;&#x79FB;&#x9664;&#x65F6;&#x8C03;&#x7528;</span>
    .shutdown = e1000_shutdown,        <span class="hljs-comment">// &#x8BBE;&#x5907;&#x5173;&#x95ED;&#x65F6;&#x8C03;&#x7528;</span>
    ...
};
<span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> __<span class="hljs-function">init <span class="hljs-title">e1000_init_module</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{
    ...
    <span class="hljs-comment">// &#x6CE8;&#x518C;&#x7F51;&#x5361;&#x9A71;&#x52A8;</span>
    ret = pci_register_driver(&amp;e1000_driver);
    ...
}
<span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> __<span class="hljs-function"><span class="hljs-built_in">exit</span> <span class="hljs-title">e1000_exit_module</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{
    <span class="hljs-comment">// &#x6CE8;&#x9500;&#x7F51;&#x5361;&#x9A71;&#x52A8;</span>
    pci_unregister_driver(&amp;e1000_driver);
}
</code></pre>
<p>&#x53EF;&#x4EE5;&#x770B;&#x5230;<code>probe</code>&#x662F;&#x5173;&#x952E;&#xFF0C;&#x90A3;<code>probe</code>&#x4EC0;&#x4E48;&#x65F6;&#x5019;&#x88AB;&#x8C03;&#x7528;&#x7684;&#x5462;&#xFF1F;&#xFF08;&#x5F88;&#x591A;&#x7F51;&#x4E0A;&#x6587;&#x7AE0;&#x8BF4;&#x662F;&#x5728;<code>call_driver_probe</code>&#x91CC;&#x9762;&#x8C03;&#x7528;&#xFF0C;&#x5176;&#x5B9E;&#x8FD8;&#x6CA1;&#x8BF4;&#x5230;&#x5E95;&#xFF0C;&#x4ED4;&#x7EC6;&#x770B;&#x4F1A;&#x53D1;&#x73B0;&#x51FD;&#x6570;&#x5B9A;&#x4E49;&#x7C7B;&#x578B;&#x4E0D;&#x4E00;&#x6837;&#xFF09;</p>
<pre><code class="lang-c"><span class="hljs-keyword">struct</span> pci_driver {
    ...
    <span class="hljs-keyword">int</span>  (*probe)(<span class="hljs-keyword">struct</span> pci_dev *dev, <span class="hljs-keyword">const</span> <span class="hljs-keyword">struct</span> pci_device_id *id);    <span class="hljs-comment">/* New device inserted */</span>
    ...
};

<span class="hljs-keyword">struct</span> bus_type {
    ...
    <span class="hljs-keyword">int</span> (*probe) (<span class="hljs-keyword">struct</span> device *dev);
    ...
};

<span class="hljs-keyword">struct</span> device_driver {
    ...
    <span class="hljs-keyword">int</span> (*probe) (<span class="hljs-keyword">struct</span> device *dev);
    ...
};
</code></pre>
<p>&#x90A3;&#x6211;&#x4EEC;&#x7EE7;&#x7EED;&#x770B;<code>pci_register_driver</code>&#x7684;&#x5B9E;&#x73B0;</p>
<pre><code class="lang-c"><span class="hljs-keyword">struct</span> bus_type pci_bus_type = {
    ...
    .name        = <span class="hljs-string">&quot;pci&quot;</span>,
    .probe        = pci_device_probe,
    ...

};
<span class="hljs-keyword">int</span> __pci_register_driver(<span class="hljs-keyword">struct</span> pci_driver *drv, <span class="hljs-keyword">struct</span> module *owner,
              <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *mod_name)
{
    <span class="hljs-comment">/* initialize common driver fields */</span>
    ...
    drv-&gt;driver.bus = &amp;pci_bus_type; <span class="hljs-comment">// &#x8FD9;&#x4E00;&#x6B65;&#x4F1A;&#x8BBE;&#x7F6E;&#x603B;&#x7EBF;&#x7C7B;&#x578B;</span>
    ...

    spin_lock_init(&amp;drv-&gt;dynids.lock);
    INIT_LIST_HEAD(&amp;drv-&gt;dynids.<span class="hljs-built_in">list</span>);

    <span class="hljs-comment">/* register with core */</span>
    <span class="hljs-keyword">return</span> driver_register(&amp;drv-&gt;driver);
}
</code></pre>
<p>&#x5728;<code>pci_device_probe -&gt; pci_call_probe -&gt; local_pci_probe -&gt;</code>&#x4E2D;&#x627E;&#x5230;&#x4E86;&#xFF1A;</p>
<pre><code class="lang-c"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">long</span> <span class="hljs-title">local_pci_probe</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *_ddi)</span>
</span>{
    ...
    pci_dev-&gt;driver = pci_drv;
    rc = pci_drv-&gt;probe(pci_dev, ddi-&gt;id);
    ...
}
</code></pre>
<p>&#x6240;&#x4EE5;&#xFF0C;&#x7F51;&#x5361;&#x9A71;&#x52A8;<code>probe</code>&#x8C03;&#x7528;&#x94FE;&#x4E3A;&#xFF1A;<code>pci_register_driver -&gt; driver_register -&gt; bus_add_driver -&gt; __driver_attach -&gt;  driver_probe_device -&gt; really_probe -&gt; call_driver_probe -&gt; bus&#x7684;probe -&gt; pci_device_probe -&gt; pci_call_probe -&gt; local_pci_probe</code></p>
<blockquote>
<p>&#x8FD9;&#x91CC;&#x6709;&#x5FC5;&#x8981;&#x7B80;&#x5355;&#x8BF4;&#x4E0B;&#xFF0C;<code>bus</code>&#x3001;<code>driver</code>&#x3001;<code>device</code>&#x7684;&#x533A;&#x522B;&#xFF1A;
<code>bus</code>&#xFF1A;&#x603B;&#x7EBF;&#xFF08;Bus&#xFF09;&#x662F;&#x6307;&#x8BA1;&#x7B97;&#x673A;&#x7EC4;&#x4EF6;&#x95F4;&#x89C4;&#x8303;&#x5316;&#x7684;&#x4EA4;&#x6362;&#x6570;&#x636E;&#xFF08;data&#xFF09;&#x7684;&#x65B9;&#x5F0F;&#xFF0C;&#x5373;&#x4EE5;&#x4E00;&#x79CD;&#x901A;&#x7528;&#x7684;&#x65B9;&#x5F0F;&#x4E3A;&#x5404;&#x7EC4;&#x4EF6;&#x63D0;&#x4F9B;&#x6570;&#x636E;&#x4F20;&#x9001;&#x548C;&#x63A7;&#x5236;&#x903B;&#x8F91;&#x3002;&#x5982;&#x679C;&#x8BF4;&#x4E3B;&#x677F;&#xFF08;Mother Board&#xFF09;&#x662F;&#x4E00;&#x5EA7;&#x57CE;&#x5E02;&#xFF0C;&#x90A3;&#x4E48;&#x603B;&#x7EBF;&#x5C31;&#x50CF;&#x662F;&#x57CE;&#x5E02;&#x91CC;&#x7684;&#x516C;&#x5171;&#x6C7D;&#x8F66;&#xFF08;bus&#xFF09;&#xFF0C;&#x80FD;&#x6309;&#x7167;&#x56FA;&#x5B9A;&#x884C;&#x8F66;&#x8DEF;&#x7EBF;&#xFF0C;&#x4F20;&#x8F93;&#x6765;&#x56DE;&#x4E0D;&#x505C;&#x8FD0;&#x4F5C;&#x7684;&#x6BD4;&#x7279;&#xFF08;bit&#xFF09;&#x3002;-- wikipedia
<code>driver</code>&#xFF1A;&#x9A71;&#x52A8;&#x7A0B;&#x5E8F;&#xFF0C;&#x63D0;&#x4F9B;&#x64CD;&#x4F5C;&#x7684;&#x8F6F;&#x4EF6;&#x63A5;&#x53E3;&#x3002;
<code>device</code>&#xFF1A;&#x8BBE;&#x5907;&#x5C31;&#x662F;&#x8FDE;&#x63A5;&#x5728;&#x603B;&#x7EBF;&#x4E0A;&#x7684;&#x7269;&#x7406;&#x5B9E;&#x4F53;&#x3002;
<img src="recv_one_package-images/bus.png" alt="recv_one_package-images/bus.png"></p>
</blockquote>
<p>&#x90A3;&#x4E0B;&#x9762;&#x63A5;&#x7740;&#x770B;<code>probe</code>&#x7684;&#x5177;&#x4F53;&#x505A;&#x4E86;&#x4E9B;&#x4EC0;&#x4E48;&#xFF1A;</p>
<pre><code class="lang-c"><span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">struct</span> net_device_ops e1000_netdev_ops = {
    .ndo_open            = e1000_open,
    .ndo_stop            = e1000_close,
    .ndo_start_xmit        = e1000_xmit_frame,
    .ndo_do_ioctl        = e1000_ioctl,
    ...
};
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">e1000_probe</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> pci_dev *pdev, <span class="hljs-keyword">const</span> <span class="hljs-keyword">struct</span> pci_device_id *ent)</span>
</span>{
    ...
    <span class="hljs-comment">// &#x8BBE;&#x7F6E;net_device_ops</span>
    netdev-&gt;netdev_ops = &amp;e1000_netdev_ops;
    <span class="hljs-comment">// &#x6CE8;&#x518C;ethtool&#x5B9E;&#x73B0;&#x51FD;&#x6570;</span>
    e1000_set_ethtool_ops(netdev);
    <span class="hljs-comment">// NAPI&#x521D;&#x59CB;&#x5316;&#xFF0C;&#x6CE8;&#x518C;poll&#x51FD;&#x6570;&#xFF08;e1000_clean&#xFF09;</span>
    netif_napi_add(netdev, &amp;adapter-&gt;napi, e1000_clean, <span class="hljs-number">64</span>);
    <span class="hljs-comment">// &#x83B7;&#x53D6;MAC&#x5730;&#x5740;</span>
    e1000_read_mac_addr(hw);
    <span class="hljs-comment">// &#x6CE8;&#x518C;net_device</span>
    <span class="hljs-built_in">strcpy</span>(netdev-&gt;name, <span class="hljs-string">&quot;eth%d&quot;</span>);
    err = register_netdev(netdev);
    ...
}
</code></pre>
<p>&#x4E0A;&#x9762;&#x7F51;&#x5361;&#x9A71;&#x52A8;&#x521D;&#x59CB;&#x5316;&#x90FD;&#x5B8C;&#x6210;&#x540E;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x542F;&#x52A8;&#x7F51;&#x5361;&#x4E86;&#x3002;&#x5F53;&#x542F;&#x52A8;&#x4E00;&#x4E2A;&#x7F51;&#x5361;&#x65F6;&#xFF0C;<code>net_device_ops</code>&#x4E2D;&#x7684;<code>e1000_open</code>&#x4F1A;&#x88AB;&#x8C03;&#x7528;&#x3002;</p>
<pre><code class="lang-c"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">e1000_open</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> net_device *netdev)</span>
</span>{
    ...
    <span class="hljs-comment">// &#x5206;&#x914D;RingBuffer&#xFF0C;&#x5206;&#x914D;RX&#x3001;TX&#x961F;&#x5217;&#x5185;&#x5B58;&#xFF0C;DMA&#x521D;&#x59CB;&#x5316;</span>
    err = e1000_setup_all_tx_resources(adapter);
    err = e1000_setup_all_rx_resources(adapter);
    <span class="hljs-comment">// &#x6CE8;&#x518C;&#x4E2D;&#x65AD;&#x5904;&#x7406;&#x51FD;&#x6570;&#xFF08;e1000_intr&#xFF09;</span>
    err = e1000_request_irq(adapter);
    <span class="hljs-comment">// &#x542F;&#x7528;NAPI</span>
    napi_enable(&amp;adapter-&gt;napi);
    ...
}
</code></pre>
<p>&#x5F53;&#x505A;&#x597D;&#x4EE5;&#x4E0A;&#x51C6;&#x5907;&#x5DE5;&#x4F5C;&#x540E;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x5F00;&#x59CB;&#x63A5;&#x6536;&#x6570;&#x636E;&#x5305;&#x4E86;&#x3002;</p>
<h2 id="&#x4E8C;&#x3001;&#x4ECE;&#x7F51;&#x7EBF;&#x5230;&#x7F51;&#x5361;">&#x4E8C;&#x3001;&#x4ECE;&#x7F51;&#x7EBF;&#x5230;&#x7F51;&#x5361;</h2>
<p><img src="recv_one_package-images/pci.png" alt="recv_one_package-images/pci.png"></p>
<p>&#x603B;&#x4E4B;&#x8FD9;&#x4E2A;&#x8FC7;&#x7A0B;&#xFF0C;<strong>&#x5B9E;&#x8D28;&#x4E0A;&#x5C31;&#x662F;&#x628A;&#x7F51;&#x7EBF;&#x4E2D;&#x7684;&#x9AD8;&#x4F4E;&#x7535;&#x5E73;&#xFF0C;&#x8F6C;&#x6362;&#x5230;&#x7F51;&#x5361;&#x4E0A;&#x7684;&#x4E00;&#x4E2A;&#x7F13;&#x51B2;&#x533A;&#x4E2D;&#x5B58;&#x50A8;&#x7740;</strong>&#x3002;</p>
<h2 id="&#x4E09;&#x3001;&#x4ECE;&#x7F51;&#x5361;&#x5230;&#x5185;&#x5B58;">&#x4E09;&#x3001;&#x4ECE;&#x7F51;&#x5361;&#x5230;&#x5185;&#x5B58;</h2>
<p>&#x6570;&#x636E;&#x5230;&#x8FBE;&#x4E86;&#x7F51;&#x5361;&#x8FD9;&#x4E2A;&#x786C;&#x4EF6;&#x7684;&#x7F13;&#x51B2;&#x533A;&#x4E2D;&#xFF0C;&#x73B0;&#x5728;&#x8981;&#x628A;&#x5B83;&#x5F04;&#x5230;<strong>&#x5185;&#x5B58;&#x4E2D;&#x7684;&#x7F13;&#x51B2;&#x533A;</strong>&#x3002;
<img src="recv_one_package-images/dma.png" alt="recv_one_package-images/dma.png"></p>
<p>&#x8FD9;&#x4E2A;&#x8FC7;&#x7A0B;&#x5B8C;&#x5168;&#x4E0D;&#x9700;&#x8981; CPU &#x53C2;&#x4E0E;&#xFF0C;&#x53EA;&#x9700;&#x8981; <strong>DMA</strong> &#x8FD9;&#x4E2A;&#x786C;&#x4EF6;&#x8BBE;&#x5907;&#xFF0C;<strong>DMA</strong> &#x7B49;&#x7F51;&#x5361;&#x7684;&#x7F13;&#x51B2;&#x533A;&#x6709;&#x6570;&#x636E;&#x5230;&#x6765;&#x65F6;&#xFF0C;&#x628A;&#x5B83;&#x62F7;&#x8D1D;&#x5230;&#x5185;&#x5B58;&#x91CC;&#x3002;
<img src="recv_one_package-images/dma_1.png" alt="recv_one_package-images/dma_1.png"></p>
<h2 id="&#x56DB;&#x3001;&#x786C;&#x4E2D;&#x65AD;&#x5904;&#x7406;">&#x56DB;&#x3001;&#x786C;&#x4E2D;&#x65AD;&#x5904;&#x7406;</h2>
<p>&#x5F53;DMA&#x64CD;&#x4F5C;&#x5B8C;&#x6210;&#x540E;&#xFF0C;&#x7F51;&#x5361;&#x4F1A;&#x5411;CPU&#x53D1;&#x8D77;&#x4E00;&#x4E2A;&#x786C;&#x4E2D;&#x65AD;&#xFF0C;&#x901A;&#x77E5;CPU&#x6709;&#x6570;&#x636E;&#x5230;&#x8FBE;&#x3002;</p>
<p>&#x4E0A;&#x9762;&#x6211;&#x4EEC;&#x8BF4;&#x4E86;&#xFF0C;&#x786C;&#x4E2D;&#x65AD;&#x5904;&#x7406;&#x51FD;&#x6570;&#x662F;<code>e1000_intr</code></p>
<pre><code class="lang-c"><span class="hljs-function"><span class="hljs-keyword">static</span> irqreturn_t <span class="hljs-title">e1000_intr</span><span class="hljs-params">(<span class="hljs-keyword">int</span> irq, <span class="hljs-keyword">void</span> *data)</span>
</span>{
    ...
    __napi_schedule(&amp;adapter-&gt;napi);
    ...
}

<span class="hljs-keyword">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">void</span> ____napi_schedule(<span class="hljs-keyword">struct</span> softnet_data *sd, <span class="hljs-keyword">struct</span> napi_struct *napi)
{
    ...
    <span class="hljs-comment">// &#x628A;napi&#x6302;&#x5230;softnet_data&#x94FE;&#x8868;&#x4E0A;</span>
    list_add_tail(&amp;napi-&gt;poll_list, &amp;sd-&gt;poll_list);
    <span class="hljs-comment">// &#x89E6;&#x53D1;&#x6536;&#x5305;&#x8F6F;&#x4E2D;&#x65AD;&#xFF08;&#x4EC5;&#x4EC5;&#x5BF9;&#x53D8;&#x91CF;&#x7684;&#x4E00;&#x6B21;&#x6216;&#x8FD0;&#x7B97;&#xFF09;</span>
    __raise_softirq_irqoff(NET_RX_SOFTIRQ);
    ...
}
</code></pre>
<p>&#x4E0A;&#x9762;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;&#x786C;&#x4E2D;&#x65AD;&#x5904;&#x7406;&#x8FC7;&#x7A0B;&#x771F;&#x7684;&#x975E;&#x5E38;&#x77ED;&#x3002;&#x53EA;&#x662F;&#x8BB0;&#x5F55;&#x4E86;&#x4E00;&#x4E2A;&#x5BC4;&#x5B58;&#x5668;&#xFF0C;&#x4FEE;&#x6539;&#x4E86;CPU&#x7684;poll_list&#xFF0C;&#x7136;&#x540E;&#x53D1;&#x51FA;&#x8F6F;&#x4E2D;&#x65AD;&#x3002;</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="./" class="navigation navigation-prev " aria-label="Previous page: 网络基础">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="dma.html" class="navigation navigation-next " aria-label="Next page: 内核DMA机制">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"内核是如何接收一个网络包的","level":"1.3.1.1","depth":3,"next":{"title":"内核DMA机制","level":"1.3.1.2","depth":3,"path":"network/basic/dma.md","ref":"./network/basic/dma.md","articles":[]},"previous":{"title":"网络基础","level":"1.3.1","depth":2,"path":"network/basic/index.md","ref":"./network/basic/index.md","articles":[{"title":"内核是如何接收一个网络包的","level":"1.3.1.1","depth":3,"path":"network/basic/recv_one_package.md","ref":"./network/basic/recv_one_package.md","articles":[]},{"title":"内核DMA机制","level":"1.3.1.2","depth":3,"path":"network/basic/dma.md","ref":"./network/basic/dma.md","articles":[]}]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["intopic-toc"],"pluginsConfig":{"intopic-toc":{"isCollapsed":true,"isScrollspyActive":true,"label":"In this article","maxDepth":6,"mode":"nested","selector":".markdown-section h1, .markdown-section h2, .markdown-section h3, .markdown-section h4, .markdown-section h5, .markdown-section h6","visible":true},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"network/basic/recv_one_package.md","mtime":"2021-11-21T14:48:11.210Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2021-11-21T14:49:12.872Z"},"basePath":"../..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../../gitbook/gitbook.js"></script>
    <script src="../../gitbook/theme.js"></script>
    
        
        <script src="../../gitbook/gitbook-plugin-intopic-toc/anchor.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-intopic-toc/gumshoe.polyfills.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-intopic-toc/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

