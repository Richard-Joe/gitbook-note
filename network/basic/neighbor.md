# 邻居子系统

给一个 L3 地址，找到对应的 L2 地址，称为 “L3地址的解析”。这个过程是由 `邻居协议` 完成的。

- IPv4 中使用 ARP （Address Resolution Protocol，地址解析协议）
- IPv6 中使用 NDP （Neighbor Discovery Protocol，邻居发现协议）

## 1. 概念

### 1.1. 什么是邻居

连接在同一个LAN上，且拥有相同的 L3 网络配置，那么就互为邻居。

### 1.2. 为什么需要邻居协议？

L3 是逻辑地址，它可以被随意改变。某些情况下，L3 地址到L2 地址的映射关系会发生变化。比如 动态配置（DHCP）、替换主机NIC（L2 变化）、L3 地址的移动（高可用）。

### 1.3. 什么情况下不需要邻居协议？

有时候 L3 地址到 L2 地址的映射不需要任何协议就能完成：

- 点对点介质连接
- 多播地址（可参考函数arp_mc_map、ip_eth_mc_map中的实现）
- 广播地址（FF:FF:FF:FF:FF:FF）

多播 IP -> MAC 规则：（比如 239.1.1.1 ->  01:00:5E:01:01:01）

- 最高 24 位指定由IANA分配的静态地址 01:00:5E
- 低 24 位的最高位设为 0
- 剩余的低 23 位直接复制相应IP地址的低 23 位

### 1.4. 请求和应答

请求（Neighbor Solicitation）：可以单播、多播、广播。
应答（Neighbor Advertisement）：通常为单播。特殊情况，可广播。

### 1.5. 通用邻居协议需要做哪些事情？

1. 缓存，存储 L3 -> L2 映射；
2. 缓存支持 add、del、update、get 等函数，查找必须要快；
3. 缓存的映射项提供一种老化机制；
4. 缓存满时且正好创建新的映射项，提供选择替换策略；
5. 为每个邻居提供一个请求队列。请求封包需要放入缓冲区，直到发出请求，并收到应答。

### 1.6. 邻居协议代理

并不是所有的 Solicitation 请求都会被代理服务器处理。代理服务器只有在满足下列条件才会应答：

- 请求的地址和代理服务器收到请求的接口上的配置的地址不属于同一个子网。否则目的主机和代理同时应答，发出方不知道应当选择哪一个。
- 必须启用代理功能。

基于设备：该设备接收的所有游戏请求都会被处理。

基于目的地址：代理可以对选定IP地址的请求做出应答。

### 1.7. NUD 状态转换

NUD：Network Unreachability Detection 网络不可到达性探测

- NUD_NONE：新创建的邻居项，还没有状态可用。
- NUD_INCOMPLETE：请求已经被发出，但还没有收到应答。这个状态下，不使用任何硬件地址。
- NUD_REACHABLE：邻居的地址已被缓存，并且知道该邻居是可到达的。
- NUD_FAILED：请求失败，将邻居标记为不可到达。
- NUD_STALE：缓存中包含一个邻居的地址，但该地址已经有一端时间没有进行确认了。当下一次有封包要到达这个邻居时，需要启动可到达性确认过程。
- NUD_DELAY：表示一种优化方式，减少 Solicitation 请求发送的次数。当发送封包到一个邻居，且其缓存项处于 NUD_STALE 状态时，就进入 NUD_DELAY 状态。该状态有时间窗口，这期间内内核不发出请求，作为一个优化方式。时间窗口内得到确认，缓存项状态就转为NUD_REACHABLE；得不到确认，就进入 NUD_PROBE 状态。
- NUD_PROBE：进入 NUD_PROBE 状态后，就开始进入 Solicitation 请求逻辑。

下面两个状态一旦被指定永远不会改变：

- NUD_PERMANENT：邻居的 L2 地址是静态配置（比如 ip neigh 命令下发），不需要邻居协议进行地址解析。
- NUD_NOARP：用于标记不要任何协议进行 L3 到 L2 地址映射的邻居。

### 1.7. 可到达性确认

两种方式：

- 来自单播的  Solicitation 应答。（处理广播应答时，缓存项状态会转移到 NUD_STALE ）
- 外部认证。（L4 调用dst_confirm_neigh函数，回调confirm_neigh函数指针，这其中只更新了neighbour->confirmed的时间戳；当邻居进入 NUD_DELAY 状态时，定时器负责将邻居状态更新为 NUD_REACHABLE 状态。）

## 2. 基础结构

## ARP分组格式

## ARP代理

## RARP